import logging
from pathlib import Path

# Set up logging configuration
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

def generate_requirements_txt(config: Config) -> str:
    """
    Generate the contents of requirements.txt based on the AI Guardian project's Python dependencies.
    
    Args:
    config (Config): The configuration object containing the debug mode and database URL.
    
    Returns:
    str: The contents of requirements.txt as a string.
    """
    try:
        # Initialize an empty list to store the dependencies
        dependencies = []
        
        # Add the TensorFlow dependency for AI-driven decision making
        dependencies.append("tensorflow")
        
        # Add the Rust-based core dependencies (not applicable in Python, skipped)
        
        # Add the nginx dependency for web server integration (not applicable in Python, skipped)
        
        # Add the API gateway dependencies for external communication
        dependencies.append("flask")
        dependencies.append("requests")
        
        # Add the database dependency for data storage and retrieval
        if config.db_url.startswith("postgres"):
            dependencies.append("psycopg2")
        elif config.db_url.startswith("mysql"):
            dependencies.append("mysql-connector-python")
        else:
            raise ValueError("Unsupported database URL")
        
        # Add the logging dependency for logging configuration
        dependencies.append("loguru")
        
        # Join the dependencies into a single string with newline characters
        requirements_txt = "\n".join(dependencies)
        
        # Log the generated requirements.txt contents
        logger.info("Generated requirements.txt contents:")
        logger.info(requirements_txt)
        
        return requirements_txt
    
    except Exception as e:
        # Log any exceptions that occur during requirements.txt generation
        logger.error(f"Error generating requirements.txt: {e}")
        raise

def write_requirements_txt(config: Config, output_path: Path) -> None:
    """
    Write the generated requirements.txt contents to a file.
    
    Args:
    config (Config): The configuration object containing the debug mode and database URL.
    output_path (Path): The file path where the requirements.txt file will be written.
    """
    try:
        # Generate the requirements.txt contents
        requirements_txt = generate_requirements_txt(config)
        
        # Write the contents to the file
        with open(output_path, "w") as f:
            f.write(requirements_txt)
        
        # Log the successful writing of requirements.txt
        logger.info(f"Requirements.txt written to {output_path}")
    
    except Exception as e:
        # Log any exceptions that occur during requirements.txt writing
        logger.error(f"Error writing requirements.txt: {e}")
        raise

# Example usage
if __name__ == "__main__":
    from src.config import Config
    config = Config(debug=True, db_url="postgres://user:password@host:port/dbname")
    output_path = Path("requirements.txt")
    write_requirements_txt(config, output_path)